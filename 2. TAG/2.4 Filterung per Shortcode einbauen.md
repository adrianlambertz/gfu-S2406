## Filterung aufbauen und per Shortcode integrieren

### Shortcode bauen

Wir wechseln in die `includes/register_shortcode.php` Datei und fügen eine neue Funktion hinzu:

```
function movie_filter_func($atts) {

    $attributes = shortcode_atts(
        array(
            'taxonomies' => 'genre,schauspieler',
        ),
        $atts,
        'movie_filter'
    );

    $taxonomies = explode(',', $attributes['taxonomies']);

    $content = '<form id="filter" action="#" method="post">';

        if( !empty($taxonomies) ) {
            foreach ($taxonomies as $taxonomy) {
                // Frage alle verfügbaren Begriffe der angegebenen Taxonomie ab
                $terms = get_terms($taxonomy);
                if( !is_wp_error($terms) ) {
                    $content .= '<select class="taxonomy-filter" id="' . esc_attr($taxonomy) . '" name="' . esc_attr($taxonomy) . '">';
                        $content .= '<option value="">Alle</option>';

                        foreach ($terms as $term) {
                            $content .= '<option value="' . esc_attr($term->slug) . '">' . esc_html($term->name) . '</option>';
                        }

                    $content .= '</select>';
                }
            }
        }

        $content .= '<input type="text" id="titel" name="titel" placeholder="Titel suchen">';
        $content .= '<input type="submit" id="apply_filters" name="apply_filters" value="Filter anwenden" />';

        $content .= '<select id="sort" name="sort">';
            $content .= '<option value="ASC">Erscheinungsdatum alt -> neu</option>';
            $content .= '<option value="DESC">Erscheinungsdatum neu -> alt</option>';
        $content .= '</select>';

    $content .= '</form>';
    $content .= '<div id="ergebnisse"></div>';

    return $content;

}

add_shortcode('movie_filter', 'movie_filter_func');
```



### Enqueue Scripts anpassen

Wir möchten unser CSS & JS nur laden, wenn `the_content()` auch den Shortcode `[movie_filter]` enthält.

Ausserdem fügen wir mit der Funktion `wp_localize_script` die URL zur admin-ajax.php Schnittstelle und einen so genannten Nonce hinzu:

```
    // prüfe ob der shortcode [movie_filter] im content ist
    if( has_shortcode( get_the_content(), 'movie_filter') ) {

        // Die CSS-Datei registrieren und einbinden
        wp_register_style('filme-css', GFU_PLUGIN_DIR . 'assets/css/filme.css' , array(), '1.0', 'all');
        wp_enqueue_style('filme-css');

        // Die JS-Datei registrieren und einbinden
        wp_register_script('filme-js', GFU_PLUGIN_DIR . 'assets/js/filme.js' , array('jquery'), '1.0', 'true');
        wp_enqueue_script('filme-js');

        wp_localize_script('filme-js', 'ajax_filter_object', 
            array(
                'ajax_url' => admin_url('admin-ajax.php'), 
                'nonce' => wp_create_nonce('ajax-nonce')
            )
        );  
    }
```

`wp_localize_script` erstellt daraufhin ein Javascript Object im HTML-Code, dass per Javascript gelesen und genutzt werden kann. Dieses Objekt werden wir in unserer JS Datei nutzen.

#### Nonce - wafür ist er da?

Ein Nonce (Number Used Once) wird hier erstellt, um die Sicherheit von Formularen und Aktionen in WordPress zu erhöhen. Es wird sichergestellt, dass die Anfrage von dem eigenen System stammt und nicht durch Cross-Site Request Forgery (CSRF) manipuliert wurde. 
Die Standardlaufzeit eines Nonce 12 Stunden. Danach kann ein Nonce und nicht mehr für die Validierung von Formularen oder Aktionen verwendet werden.


### filme.js Datei

`assets/js/filme.js` erstellen und folgenden Inhalt einfügen:

```

jQuery(function($){

    var filter = $('#filter');

    filter.on('change submit',function(e){
	    e.preventDefault();

        var taxonomies = filter.find('.taxonomy-filter');
        
        var tax_data = {};
        if( taxonomies.length ) {
            taxonomies.each(function(){
                var el = $(this);
                if( el.val() ) {
                    tax_data[el.attr('id')] = el.val();
                }
            });
        }
        var titel = filter.find('#titel').val();
        var sort = filter.find('#sort').val();

        $.ajax({
            url: ajax_filter_object.ajax_url,
	        method: 'POST',
            data: {
                'action': 'filter_filme',
                'taxonomies': tax_data,
                'titel': titel,
                'sort': sort,
                'nonce': ajax_filter_object.nonce
            },
            success: function (data) {
                try {
                    var result = JSON.parse(data);
                    console.log(result);
                    if (result.status === 'OK') {
                        var output = '<ul class="movies">';
                        for (var i = 0; i < result.posts.length; i++) {
                            output += '<li>';
                                output += '<a href="' + result.posts[i].permalink + '" title="' + result.posts[i].title + '">';
                                    output += '<img loading="lazy" src="' + result.posts[i].poster + '" alt="' + result.posts[i].title + '" />';
                                    output += '<h4>' + result.posts[i].title + '</h4>';
                                    output += '<div>' + result.posts[i].year + '</div>';
                                output += '</a>';
                            output += '</li>';
                        }
                        output += '</ul>';
                    } else {
                        output = 'Keine Filme gefunden.';
                    }
                    $('#ergebnisse').html(output);
                } catch (error) {
                    console.error('Fehler beim Parsen der JSON-Daten: ' + error.message);
                    $('#ergebnisse').html('Ein Fehler ist aufgetreten. Bitte versuche es später erneut.');
                }
            }
        });
    });

    filter.trigger('change');
});
```